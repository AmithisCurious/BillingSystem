<!-- index.html -->
{% extends 'layout.html' %} {% block title %}Billing System{% endblock %} {%
block content %}
<section class="billing-home">
  <div class="billing">
    <div class="new-bill">
      <h2>Add items to Bill</h2>
      <form id="bill-form" action="{{ url_for('create_bill') }}" method="post">
        <div class="form-group">
          <input
            type="text"
            id="code"
            name="code"
            class="form-control"
            placeholder="Code"
            onBlur="fillItemName()"
          />
        </div>
        <div class="form-group">
          <input
            type="text"
            id="item_name"
            name="item_name"
            class="form-control"
            autocomplete="off"
            oninput="getSuggestions(this.value)"
            placeholder="Item Name"
          />
          <div id="suggestions"></div>
        </div>
        <div class="form-group">
          <input
            type="number"
            id="quantity"
            name="quantity"
            class="form-control"
            min="1"
            placeholder="Quantity"
          />
        </div>
        <button class="btn-submit" type="button" onclick="addItemToBill()">
          Add Item
        </button>
      </form>
    </div>

    <div class="current-bill">
      <div class="billing-actions">
        <div id="total">Total: â‚¹ 0</div>
        <button onclick="submitBill()" class="btn-submit">Print Bill</button>
      </div>
      <table class="table">
        <thead>
          <tr>
            <th>Item</th>
            <th>Quantity</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody id="bill_items">
          <!-- This will be populated dynamically with JavaScript -->
        </tbody>
      </table>
    </div>
  </div>
  <div class="items items-home">
    <div class="resizable-item-table">
      <h2>LEGEND</h2>
      <table class="item-table item-table-home">
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Price</th>
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
            <td>{{ item.code }}</td>
            <td>{{ item.name }}</td>
            <td>{{ item.price }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<section class="modal hidden">
  <div class="text">
    <h3>Error</h3>
    <p>Insufficient Quantity</p>
  </div>
</section>

<div class="overlay hidden"></div>

<script>
  $(function () {
    $("i#del-item").on("click", function (e) {
      e.preventDefault();
      var itemId = $(this).data("item-id");
      $.getJSON("/delete-item", { item_id: itemId }, function (data) {
        console.log(data);
        window.location.reload();
      });
      return false;
    });
  });

  function fetchItemCode(itemName) {
    // Fetch item code using item name
    return fetch(`/get_item_code/${itemName}`)
      .then((response) => response.json())
      .then((data) => data.code)
      .catch((error) => {
        console.error("Error fetching item code:", error);
        return null;
      });
  }

  function fillItemName() {
    const codeField = document.getElementById("code");
    const nameField = document.getElementById("item_name");

    code = codeField.value;
    console.log(code);
    if (code != "") {
      fetch(`/get_item_name/${code}`)
        .then((response) => response.json())
        .then((data) => {
          console.log(data);
          nameField.value = data.name;
        })
        .catch((error) => console.error("Error fetching item:", error));
    }
  }

  function getSuggestions(keyword) {
    // Clear previous suggestions
    document.getElementById("suggestions").innerHTML = "";
    // Make AJAX request to fetch suggestions
    fetch(`/get_suggestions?keyword=${keyword}`)
      .then((response) => response.json())
      .then((data) => {
        // Populate suggestions div with the received suggestions
        data.forEach((suggestion) => {
          const suggestionElement = document.createElement("div");
          suggestionElement.classList.add("suggestion");
          suggestionElement.textContent = suggestion;
          suggestionElement.onclick = () => {
            document.getElementById("item_name").value = suggestion;
            document.getElementById("suggestions").innerHTML = "";
          };
          document.getElementById("suggestions").appendChild(suggestionElement);
        });
      })
      .catch((error) => console.error("Error fetching suggestions:", error));
  }

  function addItemToBill() {
    // Get the selected item's name, quantity, and price
    var itemCode = document.getElementById("code").value;
    var itemName = document.getElementById("item_name").value;
    var itemQuantity = parseInt(document.getElementById("quantity").value);

    // Check if item code is provided
    if (itemCode.trim() !== "") {
      // If item code is provided, proceed as usual
      console.log(itemCode, itemName, itemQuantity);
      addOrUpdateItemToBill(itemCode, itemName, itemQuantity);
    } else {
      // If item code is not provided, fetch it using the item name
      fetchItemCode(itemName)
        .then((code) => {
          // If item code is retrieved, add or update item to the bill
          if (code) {
            console.log(code, itemName, itemQuantity);
            addOrUpdateItemToBill(code, itemName, itemQuantity);
          } else {
            // If item code is not found, you can prompt the user to input the code manually
            // Or provide an appropriate message to the user
            console.error("Item code not found for the provided item name.");
          }
        })
        .catch((error) => console.error("Error fetching item code:", error));
    }
  }

  function addOrUpdateItemToBill(itemCode, itemName, itemQuantity) {
    // Fetch the item price from the server
    fetch(`/get_item_price?item_code=${itemCode}`)
      .then((response) => response.json())
      .then((data) => {
        var itemPrice = data.price; // Original price of the item
        if (itemPrice) {
          // Find the existing row if it exists
          var existingRow = findItemRowName(itemName);
          if (!existingRow) existingRow = findItemRow(itemCode);

          if (existingRow) {
            var existingQuantity = parseInt(existingRow.cells[1].innerHTML);
            var newQuantity = existingQuantity + itemQuantity;
            existingRow.cells[1].innerHTML = newQuantity;

            // Update total price for this item
            existingRow.cells[2].innerHTML = (itemPrice * newQuantity).toFixed(
              2
            );

            updateTotalAmount(itemQuantity * itemPrice);
          } else {
            // Create a new row for the bill table
            var table = document.getElementById("bill_items");
            var newRow = table.insertRow();

            // Insert cells for item name, quantity, price, and delete option
            var cellName = newRow.insertCell(0);
            var cellQuantity = newRow.insertCell(1);
            var cellPrice = newRow.insertCell(2);
            var cellDelete = newRow.insertCell(3);

            // Populate cells with item details
            cellName.textContent = itemName;
            cellQuantity.textContent = itemQuantity;
            cellPrice.textContent = (itemPrice * itemQuantity).toFixed(2);
            cellPrice.classList.add("price");

            // Create delete button and attach event listener
            var deleteButton = document.createElement("button");
            deleteButton.innerHTML = "&#10006;";
            deleteButton.classList.add("item-delete");
            deleteButton.onclick = function () {
              deleteItemFromBill(newRow);
            };
            cellDelete.appendChild(deleteButton);

            // Update total amount in the bill
            updateTotalAmount(itemQuantity * itemPrice);
          }
        } else {
          console.error("Price not found for the selected item.");
        }
      })
      .catch((error) => console.error("Error fetching item price:", error));
  }

  function findItemRowName(itemName) {
    var table = document.getElementById("bill_items");
    for (var i = 0; i < table.rows.length; i++) {
      if (table.rows[i].cells[0].textContent === itemName) {
        return table.rows[i];
      }
    }
    return null;
  }

  function findItemRow(itemCode) {
    var table = document.getElementById("bill_items");
    for (var i = 0; i < table.rows.length; i++) {
      fetch(
        `/check_match?item1=${table.rows[i].cells[0].textContent}&item2=${itemCode}`
      )
        .then((response) => response.json())
        .then((data) => {
          if (data.match == "Y") return table.rows[i];
        })
        .catch((error) => console.error("Error fetching item:", error));
    }
    return null;
  }

  function deleteItemFromBill(row) {
    var table = document.getElementById("bill_items");
    var quantity = parseInt(row.cells[1].textContent);
    var rowIndex = row.rowIndex;
    var price = parseFloat(row.cells[2].innerHTML);
    var itemPrice = 0;

    var itemName = row.cells[0].textContent;
    fetchItemCode(itemName)
      .then((code) => {
        if (code) {
          fetch(`/get_item_price?item_code=${code}`)
            .then((response) => response.json())
            .then((data) => {
              itemPrice = data.price;

              if (quantity > 1) {
                row.cells[1].textContent -= 1;
                row.cells[2].textContent -= itemPrice;
              } else {
                if (rowIndex >= 0 && rowIndex < table.rows.length)
                  table.deleteRow(rowIndex);
                else if (rowIndex == table.rows.length) table.deleteRow(-1);
                else console.error("Row index is out of range.");
              }

              updateTotalAmount(-itemPrice);
            });
        } else {
          console.error("Item code not found for the provided item name.");
        }
      })
      .catch((error) => console.error("Error fetching item code:", error));
  }

  function updateTotalAmount(amount) {
    var totalElement = document.getElementById("total");
    var currentTotal =
      parseFloat(totalElement.textContent.replace("Total: â‚¹", "")) || 0;

    console.log(amount, currentTotal);
    var newTotal = currentTotal + amount;
    console.log(newTotal);
    totalElement.textContent = "Total: â‚¹" + newTotal.toFixed(2);
  }

  function submitBill() {
    // Get the items from the bill table
    var tableRows = document.querySelectorAll("#bill_items tr");
    var items = [];
    var total = 0; // Initialize total amount

    tableRows.forEach(function (row) {
      var item = {
        name: row.cells[0].textContent,
        quantity: parseInt(row.cells[1].textContent),
        price: parseFloat(row.cells[2].textContent),
      };
      console.log(item);
      items.push(item);

      // Update total amount
      total += item.quantity * item.price;
    });

    // Prepare the data to send to the server
    var data = {
      items: items,
      total: total,
    };

    console.log(data);

    // Make an AJAX request to submit the bill data to the server
    fetch("/submit_bill", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(data),
    })
      .then((response) => {
        console.log(response);
        if (response.ok) {
          console.log("Bill submitted successfully");
          window.location.reload();
          window.location.href = "/print-bill/0";
        } else if (response.status === 500) {
          console.log("Insufficient Quantity");
          console.error("Failed to submit bill:", response.statusText);
          throw new Error("Failed to submit bill: " + "Insufficient Quantity");
        }
      })
      .catch((error) => {
        // Handle network or other errors
        console.error(error);
        openModal();
      });
  }
</script>
{% endblock %}
